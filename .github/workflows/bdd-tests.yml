name: Run BDD Test on PR

on:
  pull_request:
    branches:
      - main #Trigger only when the PR is made as main branch
    types:
      - opened
      - edited
      - synchronize
jobs:
  run-bdd-tests:
    runs-on: windows-latest

    steps:
    #Checkout the pr code
    - name: Checkout code
      uses: actions/checkout@v2

    #Setup Node.js environment
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14' #Install Node.js

    #Install Project dependencies
    - name: Install Dependencies
      run: npm install

    #Run BDD Tests with specified tag 
    - name: Run BDD tests with tags
      id: pr_description
      run: |
        $PR_BODY=${curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}" | jq -r .body )
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error"
          exit $LASTEXITCODE
        }
        $PR_BODY = $PR_BODY | jq -r .body
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error"
          exit $LASTEXITCODE
        }
        Write-Host "PR_DESCRIPTION=$PR_BODY" | Out-File-FilePath $env:GITHUB_ENV -Append
      shell: pwsh
      
    - name: Run BDD Tests
      run: npx cucumber-js --tags "${{env.PR_DESCRIPTION}}" --publish-quiet
